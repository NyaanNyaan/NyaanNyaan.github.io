<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=/fonts/vendor/jost/jost-v4-latin-500.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=/fonts/KaTeX_Main-Regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=/fonts/KaTeX_Math-Italic.woff2 type=font/woff2 crossorigin><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><link rel=stylesheet href=/main.98b67ccd0203d9559e633e3d60f0d96a5a9ab3337040e74da4f56d1ba51b737473b7ceb75ff495c2304796e009e2b24debb0d233cc0582a1f1d8ea1d42d7246e.css integrity="sha512-mLZ8zQID2VWeYz49YPDZalqaszNwQOdNpPVtG6Ubc3Rzt863X/SVwjBHluAJ4rJN67DSM8wFgqHx2OodQtckbg==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>AGC070E 裏話(ネタバレ注意) Nyaan's Homepage</title><meta name=description content="AGC070 E は元々は &amp;ldquo;Remove Three Edges&amp;rdquo; という題名の原案でした。つまり、今の問題の $K = 1$ 版でした。
$K = 1$ 版は想定解を気に入っていたのと個人的に何度か挫折した末に解けたので思い入れがあったのですが、10 日前くらいに maroon さんに $K$ 一般で解けることを指摘されて強化された結果、幻のバージョンに…
というわけで没になった $K = 1$ 版ですが、既に書き終えていた editorial が存在するのでこちらで公開します。
(以下、ネタバレ注意)
Editorial # はじめに数え上げる対象を整理します。まず、次の事実が証明できます。
木 $T$ が条件を満たすとする。$T$ の辺を長さ $3$ のパス $N$ 本に分割して、全てのパスに対して真ん中の辺(パスの端点を含まない辺)を青く塗る。この時、$T$ のパスをどのように分解しても、青く塗られる辺の集合は変わらない。
正当性は $T$ の根を任意に取って深さが最大の葉を端点とするパスに注目することで示せます。
この事実により、結局次の条件を満たすグラフを数え上げる問題になります。
言い換え後の問題 # 辺に赤色か青色が塗られた $3N+1$ 頂点の木であって次の条件を全て満たすものの個数は？
辺のうち $N$ 本が青く、$2N$ 本が赤く塗られている。 (赤い辺)-(青い辺)-(赤い辺) からなるパス $N$ 本に分割することが出来る。 この問題を直接解くのは少し難しいと考えられるので、まずは青い辺が連結である場合を解くことにします。そうすると条件はさらに具体的に書けて、次の問題になります。
部分問題 1 # 辺に赤色か青色が塗られた $3m+1$ 頂点の木であって次の条件を全て満たすものの個数は？
辺のうち $m$ 本が青く、$2m$ 本が赤く塗られている。 青い辺と青い辺に隣接する頂点からなるグラフは連結である。 全ての青い辺に隣接する頂点について、(隣接する青い辺の本数) と (隣接する赤い辺の本数) が一致する。 部分問題 1 の答えを $U_m$ と置きます。目標は $U_1, U_2, \dots, U_N$ を列挙することです。"><link rel=canonical href=/docs/memo/agc070e/><meta property="og:locale" content><meta property="og:type" content="article"><meta property="og:title" content="AGC070E 裏話(ネタバレ注意)"><meta property="og:description" content="AGC070 E は元々は &ldquo;Remove Three Edges&rdquo; という題名の原案でした。つまり、今の問題の $K = 1$ 版でした。
$K = 1$ 版は想定解を気に入っていたのと個人的に何度か挫折した末に解けたので思い入れがあったのですが、10 日前くらいに maroon さんに $K$ 一般で解けることを指摘されて強化された結果、幻のバージョンに…
というわけで没になった $K = 1$ 版ですが、既に書き終えていた editorial が存在するのでこちらで公開します。
(以下、ネタバレ注意)
Editorial # はじめに数え上げる対象を整理します。まず、次の事実が証明できます。
木 $T$ が条件を満たすとする。$T$ の辺を長さ $3$ のパス $N$ 本に分割して、全てのパスに対して真ん中の辺(パスの端点を含まない辺)を青く塗る。この時、$T$ のパスをどのように分解しても、青く塗られる辺の集合は変わらない。
正当性は $T$ の根を任意に取って深さが最大の葉を端点とするパスに注目することで示せます。
この事実により、結局次の条件を満たすグラフを数え上げる問題になります。
言い換え後の問題 # 辺に赤色か青色が塗られた $3N+1$ 頂点の木であって次の条件を全て満たすものの個数は？
辺のうち $N$ 本が青く、$2N$ 本が赤く塗られている。 (赤い辺)-(青い辺)-(赤い辺) からなるパス $N$ 本に分割することが出来る。 この問題を直接解くのは少し難しいと考えられるので、まずは青い辺が連結である場合を解くことにします。そうすると条件はさらに具体的に書けて、次の問題になります。
部分問題 1 # 辺に赤色か青色が塗られた $3m+1$ 頂点の木であって次の条件を全て満たすものの個数は？
辺のうち $m$ 本が青く、$2m$ 本が赤く塗られている。 青い辺と青い辺に隣接する頂点からなるグラフは連結である。 全ての青い辺に隣接する頂点について、(隣接する青い辺の本数) と (隣接する赤い辺の本数) が一致する。 部分問題 1 の答えを $U_m$ と置きます。目標は $U_1, U_2, \dots, U_N$ を列挙することです。"><meta property="og:url" content="/docs/memo/agc070e/"><meta property="og:site_name" content="Nyaan's Homepage"><meta property="article:published_time" content="2024-12-31T00:00:00+09:00"><meta property="article:modified_time" content="2024-12-31T00:00:00+09:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content><meta name=twitter:creator content><meta name=twitter:title content="AGC070E 裏話(ネタバレ注意)"><meta name=twitter:description content><meta name=twitter:card content="summary"><meta name=twitter:image:alt content="AGC070E 裏話(ネタバレ注意)"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Person","@id":"/#/schema/person/1","name":"","url":"/","sameAs":[],"image":{"@type":"ImageObject","@id":"/#/schema/image/1","url":"/\u003cnil\u003e","width":null,"height":null,"caption":""}},{"@type":"WebSite","@id":"/#/schema/website/1","url":"/","name":"Nyaan\u0027s Homepage","description":"Homepage about competitive programming.","publisher":{"@id":"/#/schema/person/1"}},{"@type":"WebPage","@id":"/docs/memo/agc070e/","url":"/docs/memo/agc070e/","name":"AGC070E 裏話(ネタバレ注意)","description":"","isPartOf":{"@id":"/#/schema/website/1"},"about":{"@id":"/#/schema/person/1"},"datePublished":"2024-12-31T00:00:00CET","dateModified":"2024-12-31T00:00:00CET","breadcrumb":{"@id":"/docs/memo/agc070e/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"/docs/memo/agc070e/#/schema/image/2"},"inLanguage":"","potentialAction":[{"@type":"ReadAction","target":["/docs/memo/agc070e/"]}]},{"@type":"BreadcrumbList","@id":"/docs/memo/agc070e/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"/","url":"/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@id":"/docsmemoagc070e/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Article","@id":"/#/schema/article/1","headline":"AGC070E 裏話(ネタバレ注意)","description":"","isPartOf":{"@id":"/docs/memo/agc070e/"},"mainEntityOfPage":{"@id":"/docs/memo/agc070e/"},"datePublished":"2024-12-31T00:00:00CET","dateModified":"2024-12-31T00:00:00CET","author":{"@id":"/#/schema/person/2"},"publisher":{"@id":"/#/schema/person/1"},"image":{"@id":"/docs/memo/agc070e/#/schema/image/2"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Person","@id":"/#/schema/person/2","name":null,"sameAs":[]}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"/docs/memo/agc070e/#/schema/image/2","url":null,"contentUrl":null,"caption":"AGC070E 裏話(ネタバレ注意)"}]}]}</script><meta name=theme-color content="#fff"><link rel=icon href=/favicon.ico sizes=any><link rel=icon type=image/svg+xml href=/favicon.svg><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=/site.webmanifest></head><body class="docs single"><div class=sticky-top><div class=header-bar></div><header class="navbar navbar-expand-lg navbar-light doks-navbar"><nav class="container-xxl flex-wrap flex-lg-nowrap" aria-label="Main navigation"><a class="navbar-brand order-0" href=/ aria-label="Nyaan's Homepage">Nyaan's Homepage</a>
<button class="btn btn-link order-0 ms-auto d-lg-none" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasExample aria-controls=offcanvasExample><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-more-horizontal"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg></button><div class="offcanvas offcanvas-start d-lg-none" tabindex=-1 id=offcanvasExample aria-labelledby=offcanvasExampleLabel><div class=header-bar></div><div class=offcanvas-header><h5 class=offcanvas-title id=offcanvasExampleLabel>Browse docs</h5><button type=button class=btn-close data-bs-dismiss=offcanvas aria-label=Close></button></div><div class=offcanvas-body><aside class="doks-sidebar mt-n3"><nav id=doks-docs-nav aria-label="Tertiary navigation"><h3>memo</h3><ul class=list-unstyled><li><a class="docs-link active" href=/docs/memo/agc070e/>AGC070E 裏話(ネタバレ注意)</a></li></ul><h3>problems</h3><ul class=list-unstyled><li><a class=docs-link href=/docs/problems/problems/>作問一覧</a></li><li><a class=docs-link href=/docs/problems/editorials/>解説一覧</a></li></ul></nav></aside></div></div><button class="btn btn-menu order-2 d-block d-lg-none" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasDoks aria-controls=offcanvasDoks aria-label="Open main menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="offcanvas offcanvas-end border-0 py-lg-1" tabindex=-1 id=offcanvasDoks data-bs-backdrop=true aria-labelledby=offcanvasDoksLabel><div class="header-bar d-lg-none"></div><div class="offcanvas-header d-lg-none"><h2 class="h5 offcanvas-title ps-2" id=offcanvasDoksLabel><a class=text-dark href=/>Nyaan's Homepage</a></h2><button type=button class="btn-close text-reset me-2" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class="offcanvas-body p-4 p-lg-0"><ul class="nav flex-column flex-lg-row align-items-lg-center mt-2 mt-lg-0 ms-lg-2 me-lg-auto"><li class=nav-item><a class="nav-link ps-0 py-1" href=/docs>Article</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=https://nyaannyaan.github.io/library/>Library</a></li></ul><hr class="text-black-50 my-4 d-lg-none"><ul class="nav flex-column flex-lg-row"><li class=nav-item><a class="nav-link social-link" href=https://github.com/NyaanNyaan><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><small class="ms-2 d-lg-none">GitHub</small></a></li></ul><hr class="text-black-50 my-4 d-lg-none"><button id=mode class="btn btn-link" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></div></div></nav></header></div><div class=container-xxl><aside class=doks-sidebar><nav id=doks-docs-nav class="collapse d-lg-none" aria-label="Tertiary navigation"><h3>memo</h3><ul class=list-unstyled><li><a class="docs-link active" href=/docs/memo/agc070e/>AGC070E 裏話(ネタバレ注意)</a></li></ul><h3>problems</h3><ul class=list-unstyled><li><a class=docs-link href=/docs/problems/problems/>作問一覧</a></li><li><a class=docs-link href=/docs/problems/editorials/>解説一覧</a></li></ul></nav></aside></div><div class="wrap container-xxl" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-5 col-xl-4 docs-sidebar d-none d-lg-block"><nav class=docs-links aria-label="Main navigation"><h3>memo</h3><ul class=list-unstyled><li><a class="docs-link active" href=/docs/memo/agc070e/>AGC070E 裏話(ネタバレ注意)</a></li></ul><h3>problems</h3><ul class=list-unstyled><li><a class=docs-link href=/docs/problems/problems/>作問一覧</a></li><li><a class=docs-link href=/docs/problems/editorials/>解説一覧</a></li></ul></nav></div><nav class="docs-toc d-none d-xl-block col-xl-3" aria-label="Secondary navigation"><div class=d-xl-none><button class="btn btn-outline-primary btn-sm doks-toc-toggle collapsed" type=button data-bs-toggle=collapse data-bs-target=#onThisPage aria-controls=doks-docs-nav aria-expanded=false aria-label="Toggle On this page navigation">
<span>On this page</span>
<span><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" class="doks doks-expand" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Expand</title><polyline points="7 13 12 18 17 13"/><polyline points="7 6 12 11 17 6"/></svg><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" class="doks doks-collapse" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Collapse</title><polyline points="17 11 12 6 7 11"/><polyline points="17 18 12 13 7 18"/></svg></span></button><div class=collapse id=onThisPage><div class="card card-body mt-3 py-1"><div class=page-links><nav id=TableOfContents><ul><li><a href=#editorial>Editorial</a><ul><li></li></ul></li></ul></nav></div></div></div></div><div class="page-links d-none d-xl-block"><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=#editorial>Editorial</a><ul><li></li></ul></li></ul></nav></div></nav><main class="docs-content col-lg-11 col-xl-9"><h1>AGC070E 裏話(ネタバレ注意)</h1><p class=lead></p><nav class=d-xl-none aria-label="Quaternary navigation"><div class=d-xl-none><button class="btn btn-outline-primary btn-sm doks-toc-toggle collapsed" type=button data-bs-toggle=collapse data-bs-target=#onThisPage aria-controls=doks-docs-nav aria-expanded=false aria-label="Toggle On this page navigation">
<span>On this page</span>
<span><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" class="doks doks-expand" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Expand</title><polyline points="7 13 12 18 17 13"/><polyline points="7 6 12 11 17 6"/></svg><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" class="doks doks-collapse" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Collapse</title><polyline points="17 11 12 6 7 11"/><polyline points="17 18 12 13 7 18"/></svg></span></button><div class=collapse id=onThisPage><div class="card card-body mt-3 py-1"><div class=page-links><nav id=TableOfContents><ul><li><a href=#editorial>Editorial</a><ul><li></li></ul></li></ul></nav></div></div></div></div><div class="page-links d-none d-xl-block"><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=#editorial>Editorial</a><ul><li></li></ul></li></ul></nav></div></nav><p>AGC070 E は元々は &ldquo;Remove Three Edges&rdquo; という題名の原案でした。つまり、今の問題の $K = 1$ 版でした。</p><p>$K = 1$ 版は想定解を気に入っていたのと個人的に何度か挫折した末に解けたので思い入れがあったのですが、10 日前くらいに maroon さんに $K$ 一般で解けることを指摘されて強化された結果、幻のバージョンに…</p><p>というわけで没になった $K = 1$ 版ですが、既に書き終えていた editorial が存在するのでこちらで公開します。</p><p>(以下、ネタバレ注意)</p><hr><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><h2 id=editorial>Editorial <a href=#editorial class=anchor aria-hidden=true>#</a></h2><p>はじめに数え上げる対象を整理します。まず、次の事実が証明できます。</p><blockquote><p>木 $T$ が条件を満たすとする。$T$ の辺を長さ $3$ のパス $N$ 本に分割して、全てのパスに対して真ん中の辺(パスの端点を含まない辺)を青く塗る。この時、$T$ のパスをどのように分解しても、青く塗られる辺の集合は変わらない。</p></blockquote><p>正当性は $T$ の根を任意に取って深さが最大の葉を端点とするパスに注目することで示せます。<br>この事実により、結局次の条件を満たすグラフを数え上げる問題になります。</p><blockquote><h4 id=言い換え後の問題>言い換え後の問題 <a href=#%e8%a8%80%e3%81%84%e6%8f%9b%e3%81%88%e5%be%8c%e3%81%ae%e5%95%8f%e9%a1%8c class=anchor aria-hidden=true>#</a></h4><p>辺に赤色か青色が塗られた $3N+1$ 頂点の木であって次の条件を全て満たすものの個数は？</p><ul><li>辺のうち $N$ 本が青く、$2N$ 本が赤く塗られている。</li><li>(赤い辺)-(青い辺)-(赤い辺) からなるパス $N$ 本に分割することが出来る。</li></ul></blockquote><p>この問題を直接解くのは少し難しいと考えられるので、まずは青い辺が連結である場合を解くことにします。そうすると条件はさらに具体的に書けて、次の問題になります。</p><blockquote><h4 id=部分問題-1>部分問題 1 <a href=#%e9%83%a8%e5%88%86%e5%95%8f%e9%a1%8c-1 class=anchor aria-hidden=true>#</a></h4><p>辺に赤色か青色が塗られた $3m+1$ 頂点の木であって次の条件を全て満たすものの個数は？</p><ul><li>辺のうち $m$ 本が青く、$2m$ 本が赤く塗られている。</li><li><strong>青い辺と青い辺に隣接する頂点からなるグラフは連結である。</strong></li><li><strong>全ての青い辺に隣接する頂点について、(隣接する青い辺の本数) と (隣接する赤い辺の本数) が一致する。</strong></li></ul></blockquote><p>部分問題 1 の答えを $U_m$ と置きます。目標は $U_1, U_2, \dots, U_N$ を列挙することです。<br>$U_m$ を計算するために適宜式変形すると、部分問題 2 が登場します。</p><blockquote><h4 id=部分問題-2>部分問題 2 <a href=#%e9%83%a8%e5%88%86%e5%95%8f%e9%a1%8c-2 class=anchor aria-hidden=true>#</a></h4><p>$n$ 頂点の無向木の重みを $\prod_{1 \leq i \leq n} \frac{1}{\deg(i)!}$ として定義する。($\deg(i)$ は頂点 $i$ の次数)<br>$n$ 頂点の木 $n^{n-2}$ 通り全てに対して重みを足し合わせた値は？</p></blockquote><p>部分問題 2 の答えを $T_n$ と置くと、$U$ と $T$ の間には</p><p>$$U_n = \binom{3n+1}{n+1} \cdot (2n)! \cdot T_{n+1}$$</p><p>という関係式が成り立ちます。よって $U_1, U_2, \dots, U_N$ を列挙するためには $T_2, T_3, \dots, T_{N+1}$ を列挙すればよいことがわかります。</p><p>$T_n$ を pruefer code を利用して計算します。頂点 $i$ の次数が $d_i$ であるような木の個数は</p><p>$$\binom{n-2}{d_1-1, d_2-1, \dots, d_n -1}$$</p><p>であり、この木の重みが $\frac{1}{d_1! d_2! \dots d_n!}$ となるようにすればよいです。よって $T_n$ は次式で表せます。</p><p>$$
\begin{aligned}
T_n &= (n-2)! \times [x^{2n-2}] \left( \sum_{m \geq 1} \frac{x^m}{(m-1)!m!}\right)^n \newline
&= \left\lbrack \frac{x^{n-2}}{(n-2)!} \right\rbrack \left( \sum_{m \geq 0} \frac{x^m}{m!(m+1)!}\right)^n
\end{aligned}
$$</p><p>この式は $T_n$ が 1 個しか計算できないのでこの式をそのまま用いて $T_n$ を列挙すると計算量が破綻します。そこでラグランジュの反転公式を使います。反転公式を振り返ると、$f(x), g(x)$ が逆関数の関係にある時に</p><p>$$\lbrack x^n \rbrack h(f(x)) = \frac{1}{n} \lbrack x^{n-1} \rbrack h^{\prime}(x) \left(\frac{x}{g(x)}\right)^n$$</p><p>が成り立つ、というものが反転公式でした。よって</p><p>$$f(x) = x\left( \sum_{m \geq 0} \frac{f(x)^m}{m!(m+1)!}\right)$$</p><p>$$g(x) = \frac{x} {\sum_{m \geq 0} \frac{x^m}{m!(m+1)!}}$$</p><p>とおくと $g(f(x)) = x$ が成り立ち $f(x), g(x)$ は逆関数の関係となるので反転公式を適用できます。</p><p>$$h(x) = \frac{x^2}{2}$$</p><p>も合わせると、</p><p>$$
\begin{aligned}
&T_n \newline
&= \left\lbrack \frac{x^{n-2}}{(n-2)!} \right\rbrack \left( \sum_{m \geq 0} \frac{x^m}{m!(m+1)!}\right)^n \newline
&= n\cdot (n-2)! \cdot \frac{1}{n} \lbrack x^{n-1} \rbrack x \left( \sum_{m \geq 0} \frac{x^m}{m!(m+1)!}\right)^n\newline
&= n\cdot (n-2)! \cdot \frac{1}{n} \lbrack x^{n-1} \rbrack h^{\prime}(x) \left(\frac{x}{g(x)}\right)^n \newline
&= n\cdot (n-2)! \cdot \lbrack x^n \rbrack h(f(x))
\end{aligned}
$$</p><p>となります。以上より</p><p>$$f(x) = x\left( \sum_{m \geq 0} \frac{f(x)^m}{m!(m+1)!}\right)$$</p><p>を満たす $f(x)$ を高速に計算すれば $T_n$ を列挙できることがわかりました。</p><p>今年、2024 年において $f(x)$ を最も手っ取り早く計算する方法は、今年発見された Kinoshita-Li algorithm (あるいは noshi91-Elegia algorithm と呼んだ方が聞き覚えがある名前かもしれませんね) を利用する方法です。</p><ul><li>Kinoshita と Li は関数合成および逆関数の計算を(次数を $N$ として) $\mathrm{O}(N \log^2 N)$ で計算するアルゴリズムを発見しました。Kinoshita と Li の論文や CodeForces での関連記事などは <a href=https://codeforces.com/blog/entry/128814>maspy さんの記事</a> に関連リンクがまとまっているのでそちらをご参照ください。</li></ul><p>$f(x)$ は $g(x)$ の逆関数で、$g(x)$ の係数は既知なので、上記のアルゴリズムを用いれば $f(x)$ の $N$ 次までの係数を $\mathrm{O}(N \log^2 N)$ で十分高速に計算できます。<br>それはそれとして、この解説では Kinoshita-Li algorithm を使用せずに $f(x)$ を $\mathrm{O}(N \log^2 N)$ で計算する方法を説明します。(余談ですがこの問題が完成したのは 2023 年のことで、当時は逆関数の計算が $\mathrm{O}(N \log^2 N)$ で出来ることになるとはゆめにも思わない時期でした)<br>さて、$P(x)$ を次のように置きます。</p><p>$$P(x) = \sum_{m \geq 0} \frac{x^m}{m!(m+1)!}$$</p><p>すると $f(x)$ は</p><p>$$G(f) = x P(f) - f = 0$$</p><p>という式を満たすので、ニュートン法、すなわち</p><p>$$f \gets f - \frac{G(f)}{G^{\prime}(f)}$$</p><p>という操作の反復により計算することが出来ます。ニュートン法の計算に必要なのは</p><p>$$G(f) = xP(f) - f, G^{\prime}(f)=xP^{\prime}(f)-1$$</p><p>なので、$f \bmod{x^k}$ が与えられたときに $P(f), P^{\prime}(f) \bmod{x^{2k}}$ を高速に計算できればよいです。$P(f)$ がわかれば $P^{\prime}(f)$ は chain rule により容易に計算できるので、以降では $f$ が与えられた時に $P(f)$ を計算するアルゴリズムを説明します。</p><p>まず、数列 $(\frac{1}{m!(m+1)!})_{m \geq 0}$ は P-recursive である事に注目すると、$P(x)$ は D-finite 、すなわち多項式係数の微分方程式で表せることがわかります。少し計算すると次の微分方程式を得られます。</p><p>$$2P^{\prime}(x) + xP^{\prime\prime}(x) = P(x)$$</p><p>よって $2P^{\prime}(f) + f P^{\prime\prime}(f) = P(f)$ という関係式を得られますが、このままでは効率的な計算が出来ません。<br>(以下では簡単のため $\frac{d}{dx}\left(f(x)\right)$ を $f(x)^{\prime}$ と書き $f^{\prime}(x)$ と区別することにする。)分割統治 FFT をするために $P^{\prime}(f), P^{\prime\prime}(f)$ を $P(f)^{\prime}, P(f)^{\prime\prime}$ に置き換えます。$P(f(x))$ の微分を考えると</p><p>$$P(f)^{\prime} = P^{\prime}(f)f^{\prime}$$</p><p>$$P(f)^{\prime\prime} = P^{\prime\prime}(f)f^{\prime 2} + P^{\prime}(f)f^{\prime\prime}$$</p><p>なので</p><p>$$P^{\prime}(f) = \frac{P(f)^{\prime}}{f^{\prime}}$$</p><p>$$P^{\prime\prime}(f) = \frac{P(f)^{\prime\prime}f^{\prime} - P(f)^{\prime}f^{\prime\prime}}{f^{\prime 3}}$$</p><p>です。これを微分方程式に代入すると</p><p>$$P(f) f^{\prime 3} = 2 P(f)^{\prime} f^{\prime 2} + f (P(f)^{\prime\prime}f^{\prime} - P(f)^{\prime}f^{\prime\prime})$$</p><p>となり、$P^{\prime}(f), P^{\prime\prime}(f)$ を $P(f)^{\prime}, P(f)^{\prime\prime}$ に置き換えることができました。簡単のため $P(f) = Q, A = f^{\prime 3}, B = ff^{\prime\prime}-2f^{\prime 2},C=-ff^{\prime}$ と置き換えると</p><p>$$QA + Q^{\prime}B + Q^{\prime\prime}C = 0$$</p><p>となり、この式は分割統治 FFT が可能です。<br>注意点も多いので分割統治 FFT の内容をもう少し深く掘り下げておきます。上式の $x^n$ の係数に注目すると</p><p>$$\left(\sum_{i=0}^n q_i A_{n-i} \right) + \left(\sum_{i=0}^n (i+1)q_{i+1}B_{n-i}\right) + \left(\sum_{i=0}^n (i+2)(i+1)q_{i+2}C_{n-i} \right)=0$$</p><p>で、$q_{n+1}, q_{n+2}$ が出て来る項のみを開くと</p><p>$$
\begin{aligned}
&\left(\sum_{i=0}^n q_{i} A_{n-i}\right)+ \newline
&\left(\sum_{i=0}^{n-1} (i+1) q_{i+1} B_{n-i}\right)+ \newline
&\left(\sum_{i=0}^{n-2} (i+2)(i+1) q_{i} C_{n-i}\right)+ \newline
&((n+1)B_0 + (n+1)n \cdot C_1) q_{n+1} + \newline
&(n + 2)(n + 1) C_0 q_{n+2}
=0
\end{aligned}
$$</p><p>を得ます。ここで、簡単な計算により $f(x)$ は</p><p>$$f(x) = x + \frac{1}{2} x^2 + \mathrm{O}(x^3)$$</p><p>を満たすことがわかるので、ニュートン法の初期解を $f(x) = x + \frac{1}{2}x^2$ から開始することにします。そうすると $C_0, C_1, B_0$ の係数が一意に定まり、</p><p>$$B_0 = -2, C_0 = 0, C_1 = -1$$</p><p>となります。これらを式に代入して整理すると</p><p>$$
\begin{aligned}
&\left(\sum_{i=0}^n q_{i} A_{n-i}\right)+ \newline
&\left(\sum_{i=1}^{n} i q_{i} B_{n+1-i}\right)+ \newline
&\left(\sum_{i=2}^{n} i(i-1) q_{i} C_{n+2-i}\right)\newline
&=(n+1)(n+2) q_{n+1}
\end{aligned}
$$</p><p>となりこの式は分割統治 FFT (relax convolution) をそのまま適用できる式になっています。</p><p>以上の内容を適切に実装することで $U_1, U_2, \dots, U_N$ を $\mathrm{O}(N \log^2 N)$ で計算することが出来ました。この値をもとに言い換え後の問題(以下に再掲しました)を解くことにします。</p><blockquote><h4 id=言い換え後の問題-1>言い換え後の問題 <a href=#%e8%a8%80%e3%81%84%e6%8f%9b%e3%81%88%e5%be%8c%e3%81%ae%e5%95%8f%e9%a1%8c-1 class=anchor aria-hidden=true>#</a></h4><p>辺に赤色か青色が塗られた $3N+1$ 頂点の木であって次の条件を全て満たすものの個数は？</p><ul><li>辺のうち $N$ 本が青く、$2N$ 本が赤く塗られている。</li><li>(赤い辺)-(青い辺)-(赤い辺) からなるパス $N$ 本に分割することが出来る。</li></ul></blockquote><p>さて、$U_1, U_2, \dots, U_N$ の情報を生かすためにグラフを捉え直します。まず、適当に根を取ってグラフを根付き木とみなします。そして、グラフを「青い辺からなる $m$ 辺の連結成分 + それに付随する $2m$ 辺の赤い辺および隣接する頂点」からなる virtual な頂点を根とする木たちに分解します。そして分解後に青い辺に隣接する頂点を青い頂点、そうでない頂点を赤い頂点と呼びます。詳しくは下図を参考にしてください。(四角い頂点が virtual な頂点です。また、1 つの木に対して根を決め打った時に分解が一意に定まることは明らかです。)</p><p><img class="img-fluid lazyload blur-up" src=https://img.atcoder.jp/agc070/5ec1868c4a9112adb9fd7d3c0cdd5bd3.jpg alt=image></p><p>このように言い換えて、数え上げる木の頂点ラベルは 「virtual な頂点、あるいは $1, 2, \dots, 3N$」を張ったものとして数えることにして問題ないです。また、virtual な頂点とその頂点に対応する virtual でない頂点 (図で言う四角い頂点とそこに隣り合う丸い頂点) の色の関係性を考えると、</p><ul><li>virtual な赤い頂点は virtual でない赤い頂点・青い頂点に対応付けられる一方、</li><li>virtual な青い頂点は virtual でない赤い頂点にしか対応付けられない(青い頂点はダメ) こと、および</li><li>virtual な青い頂点が 2 個以上同じ箇所に対応してはいけない</li></ul><p>ことが確認できます。</p><p>以上のような事実を踏まえた上で、数え上げの対象を母関数で表します。<br>$F_n, G_n, R_n, B_n$ を次のように定義します。</p><ul><li>$F_n$ : virtual な頂点の次数が $1$ で赤い頂点であるような $3n+1$ 頂点のグラフの個数</li><li>$G_n$ : virtual な頂点の次数が $1$ で青い頂点であるような $3n+1$ 頂点のグラフの個数</li><li>$R_n$ : virtual な頂点は高々 $1$ 個の青い頂点と任意の個数の赤い頂点が重なってできたものであるような $3n+1$ 頂点のグラフの個数</li><li>$B_n$ : virtual な頂点は任意の個数の赤い頂点が重なってできたものであるような $3n+1$ 頂点のグラフの個数</li></ul><p>求めたい答えは $R_N$ です。</p><p>$F_n$ の母関数 $F(x)$ を $\left\lbrack \frac{x^n}{(3n)!}\right\rbrack F(x) = F_n$ となるように定義します。($G(x), R(x), B(x)$ も同様) すると考察を重ねることにより次の関係式が成り立つことがわかります。</p><p>$$
\begin{aligned}
F_n &= (3n)! \sum_{k = 1}^n \frac{2k U_k}{(3k + 1)!} \lbrack x^{n-k} \rbrack R(x)^{2k-1} B(x)^{k+1} \newline
G_n &= (3n)! \sum_{k = 1}^n \frac{(k+1) U_k}{(3k + 1)!} \lbrack x^{n-k} \rbrack R(x)^{2k} B(x)^{k} \newline
R_n &= \left\lbrack \frac{x^n}{(3n)!} \right\rbrack \exp(F(x)) (1 + G(x)) \newline
B_n &= \left\lbrack \frac{x^n}{(3n)!} \right\rbrack \exp(F(x))
\end{aligned}
$$</p><p>これを母関数同士の関係式で表すと</p><p>$$
\begin{aligned}
F(x) &= \sum_{k = 1}^\infty \frac{2k U_k}{(3k + 1)!} R(x)^{2k-1} B(x)^{k+1} x^k \newline
G(x) &= \sum_{k = 1}^\infty \frac{(k+1) U_k}{(3k + 1)!} R(x)^{2k} B(x)^{k} x^k \newline
R(x) &= \exp(F(x)) (1 + G(x)) \newline
B(x) &= \exp(F(x))
\end{aligned}
$$</p><p>となり、$R(x), B(x)$ の式を $F(x), G(x)$ の式に代入することで</p><p>$$
\begin{aligned}
F(x) &= \sum_{k=1}^\infty \frac{2k U_k}{(3k + 1)!} \exp(3k F )(G+1)^{2k-1} x^k \newline
G(x) &= \sum_{k=1}^\infty \frac{(k+1)U_k}{(3k + 1)!} \exp(3k F) (G+1)^{2k} x^k
\end{aligned}
$$</p><p>を得られて、この式を上手く解くことが出来ればよいです。</p><p>ここで $\exp(3F(x)) (G(x)+1)^2 x = z$ と変数変換します。すると</p><p>$$
\begin{aligned}
F(G + 1) &= \sum_{k=1}^\infty \frac{2k U_k}{(3k + 1)!} z^k \newline
G &= \sum_{k=1}^\infty \frac{(k + 1)U_k}{(3k+1)!} z^k
\end{aligned}
$$</p><p>となるので、$F, G$ を $z$ で表現した時の式を得られます。これを $\hat{F}(z), \hat{G}(z)$ とします。そしてここから $x$ と $z$ の関係式</p><p>$$x = \frac{z}{\exp(3\hat{F}(z)) (\hat{G}(z) + 1)^2} := \hat{S}(z)$$</p><p>が得られます。</p><p>$x$ と $z$ の関係式が得られたので後は反転公式を利用すればよいです。すなわち、$x=\hat{S}(z)$ の逆関数を $z=\hat{S}^{\langle -1 \rangle}(x)$ と表し、また</p><p>$$R(x) = \exp(F(x)) (1 + G(x)) = \exp(\hat{F}(z)) (1 + \hat{G}(z)) := \hat{R}(z)$$</p><p>と置くと</p><p>$$
\begin{aligned}
[x^N] R(x)
&= [x^N] \hat{R}(z) \newline
&= [x^N] \hat{R}(\hat{S}^{\langle -1 \rangle}(x)) \newline
&= \frac{1}{N} \lbrack x^{N-1} \rbrack \hat{R}^{\prime}(x) \left( \frac{x}{\hat{S}(x)} \right)^{N}
\end{aligned}
$$</p><p>であり、$\hat{R}(x), \hat{S}(x)$ は既知の式なので計算できます。(なお、オーバーキル気味の別解として、$\hat{S}(z)$ を得られた時点で先述した Kinoshita-Li を利用して全てを逆関数と関数合成で処理する方法でも解けます。)</p><p>以上よりこの問題を $\mathrm{O}(N \log^2 N)$ で解くことが出来て、これは十分高速です。</p><div class="page-footer-meta d-flex flex-column flex-md-row justify-content-between"></div><div class="docs-navigation d-flex justify-content-between"><a href=/docs/problems/problems/><div class="card my-1"><div class="card-body py-2">&larr; 作問一覧</div></div></a></div></main></div></div></div><footer class="footer text-muted"><div class=container-xxl><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item>Powered by <a class=text-muted href=https://www.netlify.com/>Netlify</a>, <a class=text-muted href=https://gohugo.io/>Hugo</a>, and <a class=text-muted href=https://getdoks.org/>Doks</a></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline></ul></div></div></div></footer><script src=/js/vendor/katex/dist/katex.min.4a130545cfa0b145956b188947be680113c0368d83dc6e8957d7cb99b4aa95f507169eb70a45b618628dd68d305da05dc4dee3958464b33c112ec1047e4ec2c2.js integrity="sha512-ShMFRc+gsUWVaxiJR75oARPANo2D3G6JV9fLmbSqlfUHFp63CkW2GGKN1o0wXaBdxN7jlYRkszwRLsEEfk7Cwg==" crossorigin=anonymous defer></script>
<script src=/js/vendor/katex/dist/contrib/auto-render.min.f128dc24877a8ff5cdc694570f6cd25f8ad512d4330c242487c4cbbc5dc6fd2c52de778da1e59f98585d1defd5aa5aa583da59e90e6837973ecca3b45b01fb64.js integrity="sha512-8SjcJId6j/XNxpRXD2zSX4rVEtQzDCQkh8TLvF3G/SxS3neNoeWfmFhdHe/Vqlqlg9pZ6Q5oN5c+zKO0WwH7ZA==" crossorigin=anonymous defer></script>
<script src=/main.min.5875226de745ebdaa7caa785429c46cf383d99024cda1f9501febaff82d5f22c83db5925335734d67c303954a69582334b645f59c6143a22501a5b35fd0e41fc.js integrity="sha512-WHUibedF69qnyqeFQpxGzzg9mQJM2h+VAf66/4LV8iyD21klM1c01nwwOVSmlYIzS2RfWcYUOiJQGls1/Q5B/A==" crossorigin=anonymous defer></script></body></html>